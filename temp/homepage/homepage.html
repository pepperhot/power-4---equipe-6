<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Accueil - Puissance 4</title>
        <link rel="stylesheet" href="/assets/static/homepage_style/homepage_style.css?v=11">
    </head>
<body>
    <!-- Modal / panneau √©dition profil (cach√© par d√©faut) -->
    <div id="profileModal" class="profile-modal hidden" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
        <div class="profile-modal-backdrop"></div>
        <div class="profile-modal-content">
            <div class="modal-header">
                <h2 id="profileModalTitle">
                    <span class="modal-icon">‚ú®</span>
                    Modifier le profil
                </h2>
                <button id="closeModalBtn" class="btn-close-modal" aria-label="Fermer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Section Avatar -->
                <div class="form-section avatar-section">
                    <label class="section-label">Photo de profil</label>
                    <div class="avatar-upload-container">
                        <div class="avatar-preview-wrapper">
                            <div class="avatar-preview-circle">
                                <img id="avatarPreview" src="" alt="Aper√ßu avatar">
                                <div class="avatar-placeholder">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                            </div>
                            <div class="avatar-actions">
                                <label for="profileAvatarInput" class="btn-upload-avatar">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Choisir une photo
                                </label>
                                <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                                <button id="removeAvatarBtn" type="button" class="btn-remove-avatar">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Informations -->
                <div class="form-section">
                    <label class="section-label" for="profilePseudoInput">Pseudo</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <input type="text" id="profilePseudoInput" maxlength="20" placeholder="Votre pseudo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-section">
                        <label class="section-label" for="profileFirstNameInput">Pr√©nom</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            <input type="text" id="profileFirstNameInput" maxlength="30" placeholder="Pr√©nom">
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="section-label" for="profileLastNameInput">Nom</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            <input type="text" id="profileLastNameInput" maxlength="30" placeholder="Nom">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <label class="section-label" for="profileBioInput">Bio</label>
                    <div class="textarea-wrapper">
                        <svg class="input-icon textarea-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <textarea id="profileBioInput" maxlength="160" placeholder="Parlez-nous un peu de vous... (optionnel)"></textarea>
                        <div class="char-counter">
                            <span id="bioCharCount">0</span>/160
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="cancelProfileBtn" class="btn-cancel">Annuler</button>
                <button id="saveProfileBtn" class="btn-save">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Layout principal avec trois colonnes -->
    <div class="main-layout">
        <!-- Colonne gauche : Profil -->
        <div class="left-column">
            <div class="profile-section">
                <div class="profile-display">
                    <div class="profile-avatar-container">
                        <img id="profileAvatar" src="https://picsum.photos/seed/default-avatar/120/120.jpg" alt="Photo de profil">
                        <div class="profile-avatar-placeholder">
                            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span>Aucune photo</span>
                        </div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-names">
                            <span id="profilePseudoMain">Pseudo</span>
                        </div>
                        <div id="profilePseudo" class="profile-pseudo">@pseudo</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="editProfileBtn" class="btn-edit-profile">‚úèÔ∏è Modifier</button>
                    <a id="dashboardLink" href="/dashboard" class="btn-edit-profile btn-dashboard">üîê Dashboard Admin</a>
                </div>
            </div>
        </div>

        <!-- Colonne centre : Menu de jeu -->
        <div class="center-column">
            <div class="game-menu">
                <h1>üéÆ Puissance 4</h1>
                <p>Configurez votre partie et amusez-vous !</p>
                
                <div class="customization-panel">
                    <div class="token-shop">
                        <h2>üé® Couleurs des jetons</h2>
                        
                        <div class="player-colors">
                            <div class="color-selector">
                                <label for="player1-color">Joueur 1 :</label>
                                <input type="color" id="player1-color" value="#ff0000">
                            </div>
                            
                            <div class="color-selector">
                                <label for="player2-color">Joueur 2 :</label>
                                <input type="color" id="player2-color" value="#ffff00">
                            </div>
                        </div>
                        
                        <button class="btn-save-colors">Sauvegarder les couleurs</button>
                    </div>

                    <div class="player-names">
                        <h2>üë• Noms des joueurs</h2>
                        
                        <div class="name-inputs">
                            <div class="name-selector">
                                <label for="player1-name">Joueur 1 :</label>
                                <input type="text" id="player1-name" placeholder="Entrez votre pseudo" maxlength="20">
                            </div>
                            
                            <div class="name-selector">
                                <label for="player2-name">Joueur 2 :</label>
                                <input type="text" id="player2-name" placeholder="Entrez votre pseudo" maxlength="20">
                            </div>
                        </div>
                        
                        <button class="btn-save-names">Sauvegarder les pseudos</button>
                    </div>
                </div>
                
                <div class="mode-buttons">
                    <button type="button" class="btn-easy-mode" id="easyBtn">Facile</button>
                    <button type="button" class="btn-normale-mode" id="normalBtn">Normal</button>
                    <button type="button" class="btn-hard-mode" id="hardBtn">Difficile</button>
                    <button type="button" id="gravityBtn" class="btn-gravities-mode">Gravit√©</button>
                </div>

                <button type="button" class="btn-play" id="playBtn">üöÄ Commencer la partie</button>
            </div>
        </div>

        <!-- Colonne droite : Espace vide -->
        <div class="right-column">
            <!-- Espace vide pour √©quilibre visuel -->
        </div>
    </div>
    <script>
        // G√©rer l'affichage du placeholder de l'avatar
        document.addEventListener('DOMContentLoaded', function() {
            const avatar = document.getElementById('profileAvatar');
            const placeholder = document.querySelector('.profile-avatar-placeholder');
            const profilePseudoMain = document.getElementById('profilePseudoMain');
            const profilePseudoHandle = document.getElementById('profilePseudo');
            
            function updatePlaceholderVisibility() {
                if (avatar && placeholder) {
                    if (!avatar.src || avatar.src === '' || avatar.src.includes('about:blank') || avatar.src.includes('picsum.photos/seed/default-avatar')) {
                        placeholder.style.display = 'flex';
                    } else {
                        placeholder.style.display = 'none';
                    }
                }
            }
            
            // V√©rifier au chargement
            updatePlaceholderVisibility();

            // Charger le profil depuis la BDD pour afficher le vrai pseudo
            (async function loadProfile() {
                try {
                    const res = await fetch('/profile');
                    const data = await res.json();
                    if (data.success) {
                        if (profilePseudoMain) profilePseudoMain.textContent = data.pseudo || '';
                        if (profilePseudoHandle) profilePseudoHandle.textContent = data.pseudo ? ('@' + data.pseudo) : '';
                    }
                } catch (err) {
                    console.warn('Impossible de charger le profil sur la homepage', err);
                }
            })();
            
            // V√©rifier quand l'image change
            if (avatar) {
                avatar.addEventListener('load', updatePlaceholderVisibility);
                avatar.addEventListener('error', updatePlaceholderVisibility);
            }
            
            // G√©rer le bouton Modifier le profil
            const editProfileBtn = document.getElementById('editProfileBtn');
            const profileModal = document.getElementById('profileModal');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            
            function openProfileModal() {
                if (profileModal) {
                    profileModal.classList.remove('hidden');
                }
            }
            
            function closeProfileModal() {
                if (profileModal) {
                    profileModal.classList.add('hidden');
                }
            }
            
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openProfileModal();
                });
            }
            
            if (cancelProfileBtn) {
                cancelProfileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeProfileModal();
                });
            }
            
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeProfileModal();
                });
            }
            
            // G√©rer les boutons des modes de jeu
            let selectedMode = 'normal';
            
            const btnEasy = document.getElementById('easyBtn');
            const btnNormal = document.getElementById('normalBtn');
            const btnHard = document.getElementById('hardBtn');
            const btnGravity = document.getElementById('gravityBtn');
            const btnPlay = document.getElementById('playBtn');
            
            function setMode(mode) {
                selectedMode = mode;
                
                // Mettre √† jour les styles des boutons
                document.querySelectorAll('.mode-buttons button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                if (mode === 'easy' && btnEasy) {
                    btnEasy.classList.add('selected');
                } else if (mode === 'normal' && btnNormal) {
                    btnNormal.classList.add('selected');
                } else if (mode === 'hard' && btnHard) {
                    btnHard.classList.add('selected');
                } else if (mode === 'gravity' && btnGravity) {
                    btnGravity.classList.add('selected');
                }
            }
            
            function forceSelect(mode) {
                setMode(mode);
            }
            
            // Ajouter les √©v√©nements aux boutons
            if (btnEasy) btnEasy.addEventListener('click', () => setMode('easy'));
            if (btnNormal) btnNormal.addEventListener('click', () => setMode('normal'));
            if (btnHard) btnHard.addEventListener('click', () => setMode('hard'));
            if (btnGravity) {
                const onSelectGravity = (e) => { 
                    e.preventDefault(); 
                    forceSelect('gravity'); 
                };
                btnGravity.addEventListener('click', onSelectGravity);
                btnGravity.addEventListener('mousedown', onSelectGravity);
                btnGravity.addEventListener('touchstart', onSelectGravity, { passive: true });
            }
            
            // Bouton Play
            if (btnPlay) {
                btnPlay.addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        const res = await fetch(`/start?mode=${selectedMode}`);
                        if (!res.ok) {
                            console.error('Erreur start:', res.status);
                        }
                        
                        // Rediriger vers la bonne page selon le mode
                        if (selectedMode === 'hard') {
                            window.location.href = '/temp/grid_hard/grid_hard.html';
                        } else if (selectedMode === 'easy') {
                            window.location.href = '/temp/grid/grideasy.html';
                        } else if (selectedMode === 'gravity') {
                            window.location.href = '/temp/grid/grid_gravity.html';
                        } else {
                            window.location.href = '/temp/grid/grid.html';
                        }
                    } catch (err) {
                        console.error('Erreur lors du d√©marrage:', err);
                    }
                });
            }
            
            // Initialiser le mode normal par d√©faut
            setMode('normal');
            
            // V√©rifier si l'utilisateur est admin et afficher le lien dashboard
            checkAdminStatus();
        });
        
        // V√©rifier le statut admin
        async function checkAdminStatus() {
            try {
                const dashboardLink = document.getElementById('dashboardLink');
                if (!dashboardLink) return;
                
                // Cacher le bouton par d√©faut (s√©curit√©)
                dashboardLink.style.display = 'none';
                
                // On essaye de r√©cup√©rer le pseudo depuis localStorage,
                // mais ce n'est pas obligatoire (le backend a aussi un fallback sur config.Player1Name)
                const storedPseudo = localStorage.getItem('userPseudo') || '';
                const url = storedPseudo 
                    ? `/admin/check?pseudo=${encodeURIComponent(storedPseudo)}`
                    : '/admin/check';

                const response = await fetch(url);
                const data = await response.json();
                
                console.log('R√©ponse admin check:', data);
                
                // Afficher le bouton seulement si l'utilisateur est admin
                if (data.success && data.isAdmin) {
                    dashboardLink.style.display = 'flex';
                    console.log('Bouton Dashboard Admin affich√©');
                } else {
                    dashboardLink.style.display = 'none';
                    console.log('Utilisateur non admin - bouton Dashboard masqu√©');
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification du statut admin:', error);
                // En cas d'erreur, cacher le bouton par s√©curit√©
                const dashboardLink = document.getElementById('dashboardLink');
                if (dashboardLink) {
                    dashboardLink.style.display = 'none';
                }
            }
        }
    </script>
    <script src="/src/script/homepage_srcipt.js"></script>
</body>
</html>